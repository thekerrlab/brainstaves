<!DOCTYPE html>
<html>

<!-- Load core scripts -->
<head>
  <title>Brainstaves</title>

  <script src="assets/vue"></script> <!-- Enable Vue -- https://unpkg.com/vue -->
  <script src="assets/sciris-js.js"></script> <!-- Enable Sciris -- https://unpkg.com/sciris-js/dist/sciris-js.js -->
  <script src="assets/opensheetmusicdisplay.min.js"></script> <!-- Enable OSMD -->
  <link rel="shortcut icon" href="#" />  <!-- To avoid the favicon.ico 404 -->

  <!-- Start Bootstrap -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<link type="text/css" rel="stylesheet" href="assets/bootstrap.min.css" />
<link type="text/css" rel="stylesheet" href="assets/bootstrap-vue.min.css"/>
<script src="assets/polyfill.min.js"></script>
<script src="assets/vue.min.js"></script>
<script src="assets/bootstrap-vue.min.js"></script>
  <!-- End Bootstrap -->

  <style>
    .body {
      font-size: 0.5em;
    }

    .background {
/*      background: linear-gradient(rgba(0,0,0,1.0), rgba(0,0,0,1.0));
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height: 100vh;*/
    }

    .app {
      justify-content: center;
      display: flex;
      /*min-width: 600px;*/
    }

    .main {
      display: block;
      background-color: #000;
    }

    .thescore {
/*      border-width: 2px;
      border-color: #333;
      border-style: solid;
      background-color: #fff;
      max-width: 100vw;
      max-height: 80vh;*/
    }

    a:link    {color: #aaf;}
    a:visited {color: #aaf;}
    a:hover   {color: #33f;}
    a:active  {color: #ccf;}
  </style>

</head>


<!-- Define the layout -->
<body>
<div class="background">
  <br>
  <div id="app" class="app">
    <!-- <p>The last key press was: {{keypress}}</p> -->
<!--     <div class="main">
      <div style="display:flex; padding:0 50px 0 50px">
        <div style="justify-content: flex-start; width:33%">
          <span style='color:#fff'>B R A I N S T A V E S</span>
        </div>
        <div style="justify-content: flex-end; width:33%; text-align: center;">
          <span style='color:#ccc'><i>status: {{ isrunning }}</i></span>
        </div>
        <div style="justify-content: flex-end; width:33%; text-align:right;">
          <span><b-btn v-on:click="start()">&zigrarr;</b-btn></span>
          <span><b-btn v-on:click="stop()">&Cross;</b-btn></span>
          <br><br>
        </div>
      </div> -->

      <!-- THE SCORE -->
      <div style="position: fixed; top: 0; left: 0;">
          <span><button v-on:click="forward()">→</button></span>
          <br>
          <span><button v-on:click="backward()">←</button></span>
          <br>
          <span><button v-on:click="location.reload()">⟳</button></span>
          <br>
        </div>

      <div class="thescore" id="score">
        <img style='max-width: 95vw; max-height:95vh' name='score_img'>
      </div>


    </div>

  </div>
  <br>
</div>
</body>

<!-- Define the functionality -->
<script>
  var vm = new Vue({
    el: '#app',

    data() {
      return {
        version: 'Version information unavailable',
        isrunning: 'stopped',
        osmd: null,
        delay: 100,
        interval: 1000,
        timer: null,
        div_id: 'score',
        score_div: null,
        filename: '',
        filenumber: 1,
        keypress: 'n/a',
      }
    },

    created() {
      sciris.rpc('get_version')
              .then(function (response) {
                vm.version = response.data
                vm.makefilename()
                vm.redraw_score()
                document.onkeydown = function (e) {
                  e.stopImmediatePropagation();
                  console.log('Hi, friend! The detected key was: ' + e.key)
                  vm.keypress = e.key
                  switch (e.key) {
                      case 'ArrowLeft':
                          e.preventDefault();
                          vm.backward();
                          break;
                      case 'ArrowRight':
                          e.preventDefault();
                          vm.forward();
                          break;
                      case 'ArrowUp':
                          e.preventDefault();
                          vm.backward();
                          break;
                      case 'ArrowDown':
                          e.preventDefault();
                          vm.forward();
                          break;
                      case 'UIKeyInputUpArrow':
                          e.preventDefault();
                          vm.backward();
                          break;
                      case 'UIKeyInputDownArrow':
                          e.preventDefault();
                          vm.forward();
                          break;
                  }
                };
              })
    },

    methods: {

      makefilename() {
        vm.filename = 'live/live-' + ('0' + vm.filenumber).slice(-2) + '.png?' + Math.random();
      },

      redraw_score() {
        this.makefilename()
        console.log('Redrawing score...')
        vm.isrunning = 'running'
        document.images['score_img'].src = vm.filename
        // window.scroll(0,0) // Doesn't seem necessary
      },

      start() {
        var initial_delay = 1*(1000 - new Date().getTime() % 1000);
        console.log('Waiting ' + initial_delay + ' ms to start on the dot of the next second')
        setTimeout(function() {
          console.log('Launched')
          vm.timer = setInterval(vm.redraw_score, vm.interval);
        }, initial_delay);
      },

      forward() {
        vm.filenumber += 1
        vm.redraw_score()
      },

      backward() {
        vm.filenumber -= 1
        if (vm.filenumber < 1) {
          vm.filenumber = 1
        }
        vm.redraw_score()
      },

      stop() {
        console.log('Stopping refresh')
        vm.isrunning = 'stopped'
        clearInterval(vm.timer);
        sciris.rpc('stop')
      },

    }
  })
</script>

</html>
